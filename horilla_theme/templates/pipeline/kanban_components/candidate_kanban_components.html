{% load i18n static recruitmentfilters horillafilters %}
{% for cand in candidates %}
    <div class="task-card"
        data-candidate-id="{{cand.id}}"
        data-recruitment-id ="{{rec.id}}"
        id="canididate-{{cand.id}}"
        data-candidate = "{{cand.name}}"
        data-job-position ="{{cand.job_position_id}}"
        data-pre_stage_id ="{{cand.stage_id.id}}"
        data-stage_order = '{{cand.recruitment_id.ordered_stages|to_json|safe}}'
        onclick="window.location.href = `{% url 'candidate-view-individual' cand.id %}`"
    >
        <div class="p-[20px] rounded-[5px] text-sm relative bg-white mb-2">
            <div class="absolute inline-block dropdown-wrapper right-5 top-5 w-3" role="button" 
                onclick="event.stopPropagation()"
            >
                <a class="cursor-pointer dropdown-toggle">
                    <i class="fa-solid fa-ellipsis-vertical text-black"></i>
                </a>

                <div
                    class="dropdown-menu absolute right-0 bg-white rounded-lg shadow-card py-2 hidden z-50 transition-all duration-200 min-w-[170px]"
                >
                    <ul class="text-xs ">
                        {% if perms.recruitment.add_interviewschedule or request.user.employee_get in stage.stage_managers.all %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <a
                                    class="font-semibold"
                                    hx-get='{% url "interview-schedule" cand.id %}'
                                    hx-target="#genericModalBody"
                                    hx-swap='innerHTML'
                                    style="cursor: pointer;"
                                    data-toggle='oh-modal-toggle'
                                    data-target="#genericModal"
                                >{% trans "Schedule Interview" %}</a>
                            </li>
                        {% endif %}
                        {% if perms.recruitment.change_candidate or request.user.employee_get in stage.stage_managers.all %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <a
                                class="font-semibold"
                                hx-get='{% url "send-mail" cand.id %}'
                                hx-target='#objectDetailsModalTarget'
                                hx-swap='innerHTML'
                                style="cursor: pointer;"
                                data-toggle='oh-modal-toggle'
                                data-target='#objectDetailsModal'
                                >{% trans "Send Mail" %}</a
                                >
                            </li>
                        {% endif %}
                        {% if perms.recruitment.add_skillzonecandidate or request.user.employee_get in stage.stage_managers.all %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <a
                                class="font-semibold"
                                data-toggle="oh-modal-toggle"
                                data-target="#genericModal"
                                hx-get="{% url 'to-skill-zone' cand.id %}"
                                hx-target="#genericModalBody"
                                >{% trans "Add to Skill Zone" %}</a
                                >
                            </li>
                        {% endif %}
                        {% if check_candidate_self_tracking %}
                            {% if perms.recruitment.add_candidatedocumentrequest or request.user.employee_get in stage.stage_managers.all or request.user.employee_get in rec.recruitment_managers.all %}
                                <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300 font-semibold">
                                    <a
                                        hx-get="{% url 'candidate-document-request' %}?candidate_id={{cand.id}}"
                                        class=""
                                        data-toggle="oh-modal-toggle"
                                        data-target="#objectCreateModal"
                                        hx-target="#objectCreateModalTarget"
                                    >
                                        {% trans "Request Document" %}
                                    </a>
                                </li>
                            {% endif %}
                        {% endif %}
                        {% if "onboarding"|app_installed %} 
                            {% if perms.recruitment.add_rejectedcandidate or request.user.employee_get in stage.stage_managers.all %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <a
                                    class="font-semibold"
                                    hx-target="#rejectModalBody"
                                    hx-swap="innerHTML"
                                    class="oh-btn oh-btn--light"
                                    data-toggle="oh-modal-toggle"
                                    data-target="#rejectModal"
                                    hx-get="{% url 'add-to-rejected-candidates' %}?candidate_id={{cand.id}}"
                                    {% if cand.is_offer_rejected %}
                                        title="{% trans "Added In Rejected Candidates" %}"
                                    {% else %}
                                        title="{% trans "Add To Rejected Candidates" %}"
                                    {% endif %}
                                >
                                    {% if not cand.is_offer_rejected %}
                                        {% trans "Add to Rejected" %}
                                    {% else %}
                                        {% trans "Edit Rejected Candidate" %}
                                    {% endif %}
                                </a
                                >
                            </li>
                            {% endif %}
                        {% endif %}
                        {% if perms.view_stagenote or request.user.employee_get in stage.stage_managers.all %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <a
                                    class="font-semibold oh-activity-sidebar__open"
                                    hx-get='{% url "view-note" cand.id %}'
                                    hx-target='#activitySidebar'
                                    hx-swap="innerHTML"
                                    data-target="#activitySidebar"
                                >{% trans "Notes" %}</a
                                >
                            </li>
                        {% endif %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <a style="color: inherit;text-decoration: none;" class="font-semibold" href="{{cand.resume.url}}" target="_blank"
                                >{% trans "Resume" %}</a>
                            </li>
                        {% if perms.recruitment.change_candidate or request.user.employee_get in stage.stage_managers.all %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <a style="color: inherit;text-decoration: none;" class="font-semibold" href="{% url 'rec-candidate-update' cand.id %}" target="_blank"
                                >{% trans "Edit" %}</a>
                            </li>
                        {% endif %}
                        {% if perms.recruitment.delete_candidate %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300 font-semibold">
                                <a onclick="return confirm('{% trans "Do you want to archive this candidate?" %}')" href="{% url 'rec-candidate-archive' cand.id %}?is_active=False" class="oh-dropdown__link ">{% trans "Archive" %}</a>
                            </li>
                        {% endif %}
                        {% if perms.recruitment.delete_candidate %}
                            <li class="w-full text-left px-3 py-1 hover:text-primary-600 transition duration-300">
                                <form action="{% url 'rec-candidate-delete' cand.id %}" onsubmit="return confirm('{% trans "Are you sure you want to delete this candidate?" %}');" method="post">
                                    {% csrf_token %}
                                    <button class="oh-dropdown__link--danger ">{% trans "Delete" %}</button>
                                </form>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <div
                class="flex items-center gap-5 mb-3 pb-3 border-b border-b-[#565e6c13]"
            >
                <div>
                    <img src="{{cand.get_avatar}}" class="rounded-full" alt="" width="30" />
                </div>
                <div>
                    <span
                        class="block mb-1"
                        data-type="label"
                    >
                        {{cand}}
                        <input type="text" name="order" value="{{cand.id}}" hidden>
                        <select name="stage_id" id="" hidden>
                            {% for stage in cand.recruitment_id.stage_set.all %}
                                <option value="{{stage.id}}"
                                    {% if stage == cand.stage_id %}
                                        selected
                                    {% endif %}
                                    >{{stage}}
                                </option>
                            {% endfor %}
                        </select>
                    </span>
                    {% if request.user|stage_manages:rec or perms.recruitment.add_candidaterating %}
                        {% with request.user.employee_get.candidate_rating.all as candidate_ratings  %}
                            {% if candidate_ratings|has_candidate_rating:cand %}
                                <form hx-swap="none" hx-post='{% url "update-candidate-rating" cand.id %}' method="post">
                                    {% csrf_token %}
                                    <div class="d-block mb-0">
                                        <div class="oh-rate" onclick="event.stopPropagation();$(this).parents().closest('form').find('button').click()">
                                        {% for i in "54321" %}
                                            <input type="radio" id="star{{i}}{{cand.id}}" name="rating" class="rating-radio" value="{{i}}" {% if candidate_ratings|rating:cand == i %} checked {% endif %} />
                                            <label for="star{{i}}{{cand.id}}" title="{{i}} Stars">5 {% trans "Stars" %}</label>
                                        {% endfor %}
                                        </div>
                                        <button type="submit"  hidden="true" onclick="event.stopPropagation()"></button>
                                        <span id="rating-radio-error"></span>
                                    </div>
                                </form>
                            {% else %}
                                <form hx-swap="none" hx-post='{% url "create-candidate-rating" cand.id %}' method="post">
                                    {% csrf_token %}
                                    <div class="d-block mb-0">
                                        <div class="oh-rate" onclick="event.stopPropagation();$(this).parents().closest('form').find('button').click()">
                                        {% for i in "54321" %}
                                            <input type="radio" id="star{{i}}{{cand.id}}" name="rating" class="rating-radio" value="{{i}}" />
                                            <label for="star{{i}}{{cand.id}}" title="{{i}} Stars">5 {% trans "Stars" %}</label>
                                        {% endfor %}
                                        </div>
                                        <button type="submit" hidden="true" onclick="event.stopPropagation()"></button>
                                        <span id="rating-radio-error"></span>
                                    </div>
                                </form>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>
            </div>

            <div class="flex gap-2 items-center relative mb-2">
                <span class="font-medium text-xs text-[#565E6C] w-14"
                    >{% trans "Email" %}</span
                >
                <p class="text-xs font-semibold flex items-center gap-2">
                    : <span>{{cand.email}}</span>
                </p>
            </div>
            <div class="flex gap-2 items-center relative">
                <span class="font-medium text-xs text-[#565E6C] w-14"
                    >{% trans "Position" %}</span
                >
                <p class="text-xs font-semibold flex items-center gap-2">
                    : <span>{{cand.job_position_id}}</span>
                </p>
            </div>
        </div>
    </div>
    {% if forloop.last and candidates.has_next %}
        <div id ="pagination-container-{{cand.stage_id.id}}" >
            <div
                class="htmx-sentinel"
                hx-get="{% url 'candidate-stage-component' %}?stage_id={{cand.stage_id.id}}&view=card&candidate_page={{ candidates.next_page_number }}"
                hx-trigger="intersect once"
                hx-swap="outerHTML"
                hx-target="#pagination-container-{{cand.stage_id.id}}"
                hx-indicator=".htmx-indicator"
                id="load-more-{{cand.stage_id.id}}"
            >
                <div class="htmx-indicator" >
                    <div class="flex justify-center items-center p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-[#e54f38]"></div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endfor %}